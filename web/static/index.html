<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T2A Assistant</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a; color: #e2e8f0; min-height: 100vh;
            line-height: 1.5;
        }

        .container { max-width: 680px; margin: 0 auto; padding: 20px; }

        header { text-align: center; padding: 20px 0 16px; }
        header h1 { font-size: 22px; font-weight: 700; color: #f8fafc; }
        header p { color: #64748b; font-size: 12px; margin-top: 2px; }

        /* ---- Search ---- */
        .search-box { margin-bottom: 20px; }

        .search-box input {
            width: 100%; padding: 12px 16px; font-size: 15px;
            border: 2px solid #334155; border-radius: 10px;
            background: #1e293b; color: #f8fafc; outline: none;
        }
        .search-box input:focus { border-color: #3b82f6; }
        .search-box input::placeholder { color: #64748b; }

        /* ---- Result list ---- */
        .results-count { font-size: 12px; color: #64748b; margin-bottom: 8px; }

        .results { display: flex; flex-direction: column; gap: 6px; }

        .r-card {
            display: grid; grid-template-columns: 1fr auto;
            gap: 8px; align-items: start;
            background: #1e293b; border: 1px solid #334155; border-radius: 10px;
            padding: 14px 16px; cursor: pointer; transition: all 0.12s;
        }
        .r-card:hover { border-color: #3b82f6; background: #1e2d4a; }
        .r-card.active { border-color: #3b82f6; border-width: 2px; }

        .r-code {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-weight: 700; font-size: 14px; color: #3b82f6;
        }

        .r-label { font-size: 13px; color: #cbd5e1; margin-top: 2px; }

        .r-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }

        .r-tag {
            font-size: 10px; padding: 2px 7px; border-radius: 4px;
            background: #0f172a; color: #94a3b8;
        }
        .r-tag.green { color: #22c55e; background: #0a1a10; }

        .r-right { text-align: right; padding-top: 2px; }

        .r-icr {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 18px; font-weight: 700; color: #22c55e; line-height: 1;
        }
        .r-icr-label { font-size: 9px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }

        .r-assoc { font-size: 10px; color: #64748b; margin-top: 4px; }

        /* ---- Billing panel ---- */
        .bp {
            background: #1e293b; border: 2px solid #3b82f6; border-radius: 12px;
            padding: 20px; margin-bottom: 16px; display: none; position: relative;
        }
        .bp.visible { display: block; animation: fadeIn 0.15s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .bp-close {
            position: absolute; right: 14px; top: 12px;
            background: none; border: none; color: #64748b;
            font-size: 22px; cursor: pointer; line-height: 1;
        }
        .bp-close:hover { color: #f8fafc; }

        /* Total banner */
        .bp-total {
            background: linear-gradient(135deg, #064e3b, #0a1a10);
            border: 1px solid #22c55e44; border-radius: 10px;
            padding: 16px 18px; margin-bottom: 18px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .bp-total-left {}
        .bp-total-title { font-size: 13px; font-weight: 600; color: #d1fae5; }
        .bp-total-sub { font-size: 11px; color: #6ee7b7; margin-top: 2px; }

        .bp-total-num {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 32px; font-weight: 700; color: #22c55e; line-height: 1;
        }
        .bp-total-unit { font-size: 12px; color: #6ee7b7; margin-left: 4px; }

        /* Main act */
        .bp-section-title {
            font-size: 11px; font-weight: 700; color: #64748b;
            text-transform: uppercase; letter-spacing: 0.7px;
            margin-bottom: 8px; margin-top: 18px;
        }
        .bp-section-title:first-of-type { margin-top: 0; }

        .bp-main {
            background: #0f172a; border: 1px solid #3b82f633; border-radius: 8px;
            padding: 14px;
        }

        .bp-main-top { display: flex; justify-content: space-between; align-items: center; }

        .bp-main-code {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-weight: 700; font-size: 16px; color: #f8fafc;
        }

        .bp-main-icr { font-size: 16px; font-weight: 700; color: #22c55e; }

        .bp-main-label { font-size: 13px; color: #94a3b8; margin-top: 6px; line-height: 1.4; }

        .bp-main-note {
            margin-top: 8px; padding: 8px 10px; border-radius: 6px;
            font-size: 12px; line-height: 1.4;
            color: #fbbf24; background: #1a170a; border: 1px solid #fbbf2422;
        }

        .bp-main-note.danger {
            color: #f87171; background: #1a0a0a; border-color: #f8717122;
        }

        /* Gesture rows */
        .g-row {
            display: flex; align-items: flex-start; gap: 10px;
            padding: 10px 12px; background: #0f172a;
            border: 1px solid #1e293b; border-radius: 8px;
            margin-bottom: 4px; cursor: pointer; user-select: none;
            transition: all 0.1s;
        }
        .g-row:hover { border-color: #334155; }
        .g-row.on { border-color: #22c55e55; background: #071210; }

        .g-check {
            width: 20px; height: 20px; min-width: 20px;
            border: 2px solid #475569; border-radius: 5px;
            display: flex; align-items: center; justify-content: center;
            margin-top: 1px; transition: all 0.1s;
        }

        .g-row.on .g-check { background: #22c55e; border-color: #22c55e; }

        .g-row.on .g-check::after {
            content: ''; width: 5px; height: 9px;
            border: solid #0f172a; border-width: 0 2px 2px 0;
            transform: rotate(45deg); margin-bottom: 2px;
        }

        .g-body { flex: 1; min-width: 0; }
        .g-top { display: flex; justify-content: space-between; align-items: center; }

        .g-code {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-weight: 600; font-size: 13px; color: #3b82f6;
        }

        .g-icr { font-size: 13px; font-weight: 600; color: #22c55e; }
        .g-icr.muted { color: #475569; }

        .g-label { font-size: 12px; color: #94a3b8; line-height: 1.3; margin-top: 2px; }

        .bp-empty {
            padding: 14px; text-align: center; color: #475569;
            font-size: 12px; background: #0f172a; border-radius: 8px;
        }

        /* Actions */
        .bp-actions { display: flex; gap: 8px; margin-top: 16px; }

        .bp-btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            transition: all 0.15s;
        }
        .bp-btn-primary { background: #3b82f6; color: #fff; }
        .bp-btn-primary:hover { background: #2563eb; }
        .bp-btn-primary.ok { background: #22c55e; }

        .bp-btn-secondary { background: #1e293b; color: #94a3b8; border: 1px solid #334155; }
        .bp-btn-secondary:hover { background: #334155; color: #f8fafc; }

        .bp-source { font-size: 9px; color: #334155; text-align: center; margin-top: 10px; }

        /* Confidence badges */
        .g-conf {
            font-size: 9px; padding: 1px 5px; border-radius: 3px;
            font-weight: 600; letter-spacing: 0.3px; margin-left: 6px;
        }
        .g-conf.verified { color: #22c55e; background: #0a1a10; }
        .g-conf.same_chapter { color: #3b82f6; background: #0c1a2e; }
        .g-conf.cross_chapter { color: #94a3b8; background: #1e293b; }

        .bp-freq-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 18px; margin-bottom: 8px;
        }

        .bp-freq-toggle {
            font-size: 10px; color: #3b82f6; background: none; border: none;
            cursor: pointer; font-weight: 600;
        }
        .bp-freq-toggle:hover { color: #60a5fa; }

        /* States */
        .loading { text-align: center; padding: 40px; color: #64748b; font-size: 13px; }
        .empty { text-align: center; padding: 50px 20px; color: #475569; font-size: 14px; }
        .stats { text-align: center; font-size: 10px; color: #1e293b; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>T2A Assistant</h1>
            <p>Aide au codage CCAM</p>
        </header>

        <div class="search-box">
            <input type="text" id="q" placeholder="Decrivez l'intervention (ex: arthrodese cervicale, hernie discale...)" autofocus>
        </div>

        <div class="bp" id="bp"></div>
        <div id="res"></div>
        <div class="stats" id="stats"></div>
    </div>

<script>
const q = document.getElementById('q');
const res = document.getElementById('res');
const bp = document.getElementById('bp');

let timer, active = null, plan = null, checked = null;

fetch('/api/stats').then(r=>r.json()).then(d => {
    document.getElementById('stats').textContent =
        `${d.active_codes.toLocaleString()} codes | ${d.associations.toLocaleString()} officielles + ${(d.frequent_associations||0).toLocaleString()} PMSI | ${d.version}`;
});

q.addEventListener('input', () => { clearTimeout(timer); timer = setTimeout(search, 250); });
q.addEventListener('keydown', e => { if(e.key==='Enter'){clearTimeout(timer); search();} });

async function search() {
    const v = q.value.trim();
    if (!v) {
        res.innerHTML = '<div class="empty">Decrivez une intervention pour commencer</div>';
        closeBp();
        return;
    }
    res.innerHTML = '<div class="loading">Recherche...</div>';

    try {
        const r = await fetch(`/api/search?q=${encodeURIComponent(v)}&limit=15`).then(r=>r.json());
        if (!r.results.length) { res.innerHTML = '<div class="empty">Aucun resultat. Essayez d\'autres termes.</div>'; return; }

        const sorted = r.results.sort((a, b) => (b.icr_public || 0) - (a.icr_public || 0));

        let h = `<div class="results-count">${r.count} resultat${r.count>1?'s':''}, tries par valeur</div>`;
        h += '<div class="results">';
        for (const x of sorted) {
            const icr = x.icr_public || 0;
            const chapter = x.paragraph_title || x.subchapter_title || '';

            h += `<div class="r-card ${active===x.code?'active':''}" onclick="openBp('${x.code}')">
                <div>
                    <div class="r-code">${x.code}</div>
                    <div class="r-label">${x.label}</div>
                    <div class="r-tags">
                        ${chapter ? `<span class="r-tag">${truncate(chapter,40)}</span>` : ''}
                        ${x.classant==='Oui' ? '<span class="r-tag">Classant</span>' : ''}
                        ${x.assoc_count ? `<span class="r-tag green">+${x.assoc_count} geste${x.assoc_count>1?'s':''}</span>` : ''}
                        ${x.date_end ? '<span class="r-tag" style="color:#f87171;background:#1a0a0a">Expire</span>' : ''}
                    </div>
                </div>
                <div class="r-right">
                    ${icr ? `<div class="r-icr">${icr}</div><div class="r-icr-label">ICR</div>` : '<div style="color:#475569">-</div>'}
                </div>
            </div>`;
        }
        h += '</div>';
        res.innerHTML = h;
    } catch(e) {
        res.innerHTML = '<div class="empty">Erreur de recherche.</div>';
    }
}

let freqExpanded = false;

async function openBp(code) {
    if (active === code) { closeBp(); return; }
    active = code;
    freqExpanded = false;
    search();

    bp.innerHTML = '<div class="loading">Chargement...</div>';
    bp.classList.add('visible');

    try {
        plan = await fetch(`/api/billing-plan/${code}`).then(r=>r.json());
        if (plan.error) { bp.innerHTML = `<div class="empty">${plan.error}</div>`; return; }

        // Pre-check official gestures + verified frequent associations by default
        checked = new Set([
            ...plan.complementary_gestures.map(g => g.code),
            ...plan.anesthesia_codes.map(a => a.code),
            ...(plan.frequent_associations || []).filter(f => f.confidence === 'verified').map(f => f.code)
        ]);

        renderBp();
    } catch(e) {
        bp.innerHTML = '<div class="empty">Erreur de chargement.</div>';
    }
}

function renderBp() {
    const m = plan.main_code;
    const gs = plan.complementary_gestures;
    const an = plan.anesthesia_codes;
    const freq = plan.frequent_associations || [];
    const allItems = [...gs, ...an, ...freq];

    const mainIcr = m.icr_public || 0;
    const selIcr = allItems.filter(g => checked.has(g.code)).reduce((s, g) => s + (g.icr_public || 0), 0);
    const total = mainIcr + selIcr;
    const selCount = checked.size;

    let h = `<button class="bp-close" onclick="closeBp()">&times;</button>`;

    // ---- TOTAL BANNER ----
    h += `<div class="bp-total">
            <div class="bp-total-left">
                <div class="bp-total-title">Total facturation</div>
                <div class="bp-total-sub">Acte principal + ${selCount} geste${selCount!==1?'s':''} selectionne${selCount!==1?'s':''}</div>
            </div>
            <div>
                <span class="bp-total-num">${total || '-'}</span>
                <span class="bp-total-unit">ICR</span>
            </div>
          </div>`;

    // ---- ACTE PRINCIPAL ----
    h += `<div class="bp-section-title">Acte principal</div>`;
    h += `<div class="bp-main">
            <div class="bp-main-top">
                <span class="bp-main-code">${m.code}</span>
                <span class="bp-main-icr">${mainIcr || '-'} ICR</span>
            </div>
            <div class="bp-main-label">${m.label}</div>
            ${m.coding_instruction ? `<div class="bp-main-note">${m.coding_instruction}</div>` : ''}
            ${m.date_end ? `<div class="bp-main-note danger">Code expire le ${m.date_end}</div>` : ''}
          </div>`;

    // ---- GESTES COMPLEMENTAIRES OFFICIELS ----
    if (gs.length > 0 || an.length > 0) {
        h += `<div class="bp-section-title">Gestes complementaires officiels ATIH (${gs.length + an.length})</div>`;

        const allSorted = [...gs, ...an].sort((a, b) => (b.icr_public || 0) - (a.icr_public || 0));
        for (const g of allSorted) {
            const on = checked.has(g.code);
            const icr = g.icr_public;
            h += `<div class="g-row ${on?'on':''}" onclick="toggle('${g.code}')">
                    <div class="g-check"></div>
                    <div class="g-body">
                        <div class="g-top">
                            <span class="g-code">${g.code}</span>
                            <span class="g-icr ${icr?'':'muted'}">${icr ? '+'+icr+' ICR' : 'supplement'}</span>
                        </div>
                        <div class="g-label">${g.label || '-'}</div>
                    </div>
                  </div>`;
        }
    }

    // ---- ASSOCIATIONS FREQUENTES (PMSI) ----
    if (freq.length > 0) {
        const displayLimit = freqExpanded ? freq.length : 10;
        const shown = freq.slice(0, displayLimit);
        const confLabel = {verified: 'Verifie ATIH', same_chapter: 'Meme region', cross_chapter: 'Autre region'};

        h += `<div class="bp-freq-header">
                <span class="bp-section-title" style="margin:0">Associations frequentes PMSI (${freq.length})</span>
                ${freq.length > 10 ? `<button class="bp-freq-toggle" onclick="toggleFreqExpand()">${freqExpanded ? 'Voir moins' : 'Voir tout ('+freq.length+')'}</button>` : ''}
              </div>`;

        for (const f of shown) {
            const on = checked.has(f.code);
            const icr = f.icr_public;
            const conf = f.confidence || 'cross_chapter';
            h += `<div class="g-row ${on?'on':''}" onclick="toggle('${f.code}')">
                    <div class="g-check"></div>
                    <div class="g-body">
                        <div class="g-top">
                            <span class="g-code">${f.code}</span>
                            <span class="g-conf ${conf}">${confLabel[conf] || conf}</span>
                            <span style="flex:1"></span>
                            <span class="g-icr ${icr?'':'muted'}">${icr ? '+'+icr+' ICR' : '-'}</span>
                        </div>
                        <div class="g-label">${f.label || '-'}</div>
                    </div>
                  </div>`;
        }
    }

    // No associations at all
    if (gs.length === 0 && an.length === 0 && freq.length === 0) {
        h += `<div class="bp-section-title">Associations</div>`;
        h += `<div class="bp-empty">Aucune association trouvee pour cet acte.</div>`;
    }

    // ---- ACTIONS ----
    h += `<div class="bp-actions">
            <button class="bp-btn bp-btn-primary" onclick="copyPlan()">Copier le plan</button>
            <button class="bp-btn bp-btn-secondary" onclick="closeBp()">Fermer</button>
          </div>`;

    h += `<div class="bp-source">Sources : ATIH CCAM 2025 v4 (officielles) + Donnees PMSI (frequentes, validees)</div>`;

    bp.innerHTML = h;
}

function toggleFreqExpand() {
    freqExpanded = !freqExpanded;
    renderBp();
}

function toggle(code) {
    if (checked.has(code)) checked.delete(code); else checked.add(code);
    renderBp();
}

function closeBp() {
    active = null; plan = null; checked = null;
    bp.classList.remove('visible'); bp.innerHTML = '';
    search();
}

async function copyPlan() {
    const m = plan.main_code;
    const official = [...plan.complementary_gestures, ...plan.anesthesia_codes];
    const freq = plan.frequent_associations || [];
    const selOfficial = official.filter(g => checked.has(g.code));
    const selFreq = freq.filter(f => checked.has(f.code));
    const mainIcr = m.icr_public || 0;
    const selIcr = [...selOfficial, ...selFreq].reduce((s, g) => s + (g.icr_public || 0), 0);

    let t = `PLAN DE FACTURATION\n\n`;
    t += `Acte principal :\n  ${m.code} - ${m.label}\n  ICR : ${mainIcr}\n\n`;
    if (selOfficial.length) {
        t += `Gestes complementaires officiels :\n`;
        selOfficial.forEach(g => { t += `  ${g.code} - ${g.label || '-'} (ICR ${g.icr_public || 0})\n`; });
        t += `\n`;
    }
    if (selFreq.length) {
        t += `Associations frequentes (PMSI) :\n`;
        selFreq.forEach(f => { t += `  ${f.code} - ${f.label || '-'} (ICR ${f.icr_public || 0})\n`; });
        t += `\n`;
    }
    t += `TOTAL ICR : ${mainIcr + selIcr}\n\nSources : ATIH CCAM 2025 v4 + Donnees PMSI`;

    try { await navigator.clipboard.writeText(t); } catch(e) {
        const ta = document.createElement('textarea'); ta.value = t;
        document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    }
    const btn = document.querySelector('.bp-btn-primary');
    btn.textContent = 'Copie !'; btn.classList.add('ok');
    setTimeout(() => { btn.textContent = 'Copier le plan'; btn.classList.remove('ok'); }, 1500);
}

function truncate(s, n) { return s && s.length > n ? s.substring(0, n) + '...' : (s || ''); }
</script>
</body>
</html>
