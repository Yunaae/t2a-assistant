<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T2A Assistant</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }

        .container { max-width: 720px; margin: 0 auto; padding: 16px; }

        header { text-align: center; padding: 24px 0 16px; }
        header h1 { font-size: 24px; font-weight: 700; color: #f8fafc; }
        header p { color: #64748b; font-size: 13px; margin-top: 2px; }

        /* Search */
        .search-box { margin: 12px 0 16px; }

        .search-box input {
            width: 100%; padding: 14px 16px; font-size: 16px;
            border: 2px solid #334155; border-radius: 12px;
            background: #1e293b; color: #f8fafc; outline: none;
        }

        .search-box input:focus { border-color: #3b82f6; }
        .search-box input::placeholder { color: #64748b; }

        /* Results */
        .results { display: flex; flex-direction: column; gap: 4px; }

        .result-card {
            background: #1e293b; border: 1px solid #334155; border-radius: 8px;
            padding: 10px 14px; cursor: pointer; transition: all 0.12s;
            display: flex; justify-content: space-between; align-items: center; gap: 12px;
        }

        .result-card:hover { border-color: #3b82f6; }
        .result-card.active { border-color: #3b82f6; border-width: 2px; background: #1e2d4a; }

        .result-left { flex: 1; min-width: 0; }

        .result-code {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-weight: 700; font-size: 13px; color: #3b82f6;
        }

        .result-label {
            font-size: 12px; color: #94a3b8; line-height: 1.3;
            margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .result-right { text-align: right; min-width: 70px; }

        .result-icr { font-size: 16px; font-weight: 700; color: #22c55e; }

        .result-assoc { font-size: 10px; color: #64748b; margin-top: 1px; }

        .result-expired { font-size: 10px; color: #ef4444; font-weight: 600; }

        /* Billing panel */
        .billing-panel {
            background: #1e293b; border: 2px solid #3b82f6; border-radius: 12px;
            padding: 16px; margin: 12px 0; display: none;
            animation: slideIn 0.12s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .billing-panel.visible { display: block; }

        /* Total at the TOP */
        .total-box {
            background: #0a1a10; border: 2px solid #22c55e; border-radius: 10px;
            padding: 14px 16px; margin-bottom: 16px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .total-left {}
        .total-label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
        .total-detail { font-size: 12px; color: #94a3b8; margin-top: 2px; }

        .total-value {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 28px; font-weight: 700; color: #22c55e;
        }

        .total-close {
            position: absolute; right: 16px; top: 12px;
            background: none; border: none; color: #64748b;
            font-size: 20px; cursor: pointer;
        }

        .total-close:hover { color: #f8fafc; }

        /* Main act */
        .main-act {
            background: #0f172a; border: 1px solid #3b82f6; border-radius: 8px;
            padding: 12px; margin-bottom: 12px; position: relative;
        }

        .main-act-tag {
            font-size: 9px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: #3b82f6; margin-bottom: 4px;
        }

        .main-act-row {
            display: flex; justify-content: space-between; align-items: center;
        }

        .main-act-code {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-weight: 700; font-size: 15px; color: #f8fafc;
        }

        .main-act-icr { font-size: 15px; font-weight: 700; color: #22c55e; }

        .main-act-label { font-size: 12px; color: #94a3b8; line-height: 1.3; margin-top: 4px; }

        .main-act-warning {
            margin-top: 6px; padding: 6px 8px; border-radius: 4px;
            font-size: 11px; color: #f59e0b; background: #1a1708; border: 1px solid #f59e0b33;
        }

        /* Gestures list */
        .gestures-header {
            font-size: 11px; font-weight: 700; color: #64748b;
            text-transform: uppercase; letter-spacing: 0.5px;
            margin: 12px 0 6px; display: flex; justify-content: space-between;
        }

        .gesture {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 10px; background: #0f172a; border: 1px solid #334155;
            border-radius: 6px; margin-bottom: 3px; cursor: pointer;
            transition: all 0.1s; user-select: none;
        }

        .gesture:hover { border-color: #475569; }
        .gesture.on { border-color: #22c55e; background: #0a1a10; }

        .gesture-check {
            width: 18px; height: 18px; min-width: 18px;
            border: 2px solid #475569; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }

        .gesture.on .gesture-check {
            background: #22c55e; border-color: #22c55e;
        }

        .gesture.on .gesture-check::after {
            content: ''; width: 4px; height: 8px;
            border: solid #0f172a; border-width: 0 2px 2px 0;
            transform: rotate(45deg); margin-bottom: 2px;
        }

        .gesture-body { flex: 1; min-width: 0; }

        .gesture-top { display: flex; justify-content: space-between; align-items: center; }

        .gesture-code {
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-weight: 600; font-size: 12px; color: #3b82f6;
        }

        .gesture-icr { font-size: 12px; font-weight: 600; color: #22c55e; }
        .gesture-icr.zero { color: #475569; }

        .gesture-label { font-size: 11px; color: #94a3b8; line-height: 1.2; margin-top: 1px; }

        .no-gestures {
            padding: 12px; text-align: center; color: #475569; font-size: 12px;
            background: #0f172a; border-radius: 6px;
        }

        /* Actions */
        .actions { display: flex; gap: 8px; margin-top: 12px; }

        .btn {
            flex: 1; padding: 10px; border: none; border-radius: 8px;
            font-size: 12px; font-weight: 600; cursor: pointer;
        }

        .btn-copy { background: #3b82f6; color: #fff; }
        .btn-copy:hover { background: #2563eb; }
        .btn-copy.ok { background: #22c55e; }

        .btn-close { background: #334155; color: #94a3b8; }
        .btn-close:hover { background: #475569; color: #f8fafc; }

        .source { font-size: 9px; color: #334155; text-align: center; margin-top: 8px; }

        /* States */
        .loading { text-align: center; padding: 40px; color: #64748b; font-size: 13px; }
        .empty { text-align: center; padding: 50px 20px; color: #475569; font-size: 13px; }

        .stats { text-align: center; font-size: 10px; color: #1e293b; margin-top: 24px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>T2A Assistant</h1>
            <p>Aide au codage CCAM</p>
        </header>

        <div class="search-box">
            <input type="text" id="q" placeholder="Decrivez l'intervention..." autofocus>
        </div>

        <div class="billing-panel" id="bp"></div>
        <div id="res"></div>
        <div class="stats" id="stats"></div>
    </div>

    <script>
        const q = document.getElementById('q');
        const res = document.getElementById('res');
        const bp = document.getElementById('bp');

        let timer, active = null, plan = null, checked = null;

        fetch('/api/stats').then(r=>r.json()).then(d => {
            document.getElementById('stats').textContent =
                `${d.active_codes} codes | ${d.associations} associations | ${d.version}`;
        });

        q.addEventListener('input', () => { clearTimeout(timer); timer = setTimeout(search, 250); });
        q.addEventListener('keydown', e => { if(e.key==='Enter'){clearTimeout(timer);search();} });

        async function search() {
            const v = q.value.trim();
            if (!v) { res.innerHTML = '<div class="empty">Decrivez une intervention pour commencer</div>'; close(); return; }

            res.innerHTML = '<div class="loading">Recherche...</div>';

            const r = await fetch(`/api/search?q=${encodeURIComponent(v)}&limit=15`).then(r=>r.json());
            if (!r.results.length) { res.innerHTML = '<div class="empty">Aucun resultat</div>'; return; }

            // Sort by ICR descending (highest billing first), keep relevance for ties
            const sorted = r.results.sort((a, b) => (b.icr_public || 0) - (a.icr_public || 0));

            let h = '<div class="results">';
            for (const x of sorted) {
                const isActive = active === x.code;
                const icr = x.icr_public || 0;
                h += `<div class="result-card ${isActive?'active':''}" onclick="open_('${x.code}')">
                    <div class="result-left">
                        <span class="result-code">${x.code}</span>
                        <div class="result-label">${x.label}</div>
                    </div>
                    <div class="result-right">
                        ${icr ? `<div class="result-icr">${icr}</div>` : '<div style="color:#475569;font-size:13px">-</div>'}
                        ${x.assoc_count ? `<div class="result-assoc">+${x.assoc_count} geste${x.assoc_count>1?'s':''}</div>` : ''}
                        ${x.date_end ? '<div class="result-expired">EXPIRE</div>' : ''}
                    </div>
                </div>`;
            }
            h += '</div>';
            res.innerHTML = h;
        }

        async function open_(code) {
            if (active === code) { close(); return; }

            active = code;
            search();

            bp.innerHTML = '<div class="loading">Chargement...</div>';
            bp.classList.add('visible');

            plan = await fetch(`/api/billing-plan/${code}`).then(r=>r.json());
            if (plan.error) { bp.innerHTML = `<div class="empty">${plan.error}</div>`; return; }

            // Pre-check ALL gestures (maximize billing by default)
            checked = new Set([
                ...plan.complementary_gestures.map(g => g.code),
                ...plan.anesthesia_codes.map(a => a.code)
            ]);

            render();
        }

        function render() {
            const m = plan.main_code;
            const gs = plan.complementary_gestures;
            const an = plan.anesthesia_codes;
            const all = [...gs, ...an];

            const mainIcr = m.icr_public || 0;
            const gestIcr = all.filter(g => checked.has(g.code)).reduce((s, g) => s + (g.icr_public || 0), 0);
            const total = mainIcr + gestIcr;
            const count = checked.size;

            let h = `<div style="position:relative">`;

            // TOTAL at the top â€” the most important info
            h += `<div class="total-box">
                    <div class="total-left">
                        <div class="total-label">Total facturation</div>
                        <div class="total-detail">${m.code} + ${count} geste${count>1?'s':''}</div>
                    </div>
                    <div class="total-value">${total > 0 ? total : '-'} <span style="font-size:14px;color:#64748b">ICR</span></div>
                    <button class="total-close" onclick="close()">&times;</button>
                  </div>`;

            // Main act
            h += `<div class="main-act">
                    <div class="main-act-tag">Acte principal</div>
                    <div class="main-act-row">
                        <span class="main-act-code">${m.code}</span>
                        <span class="main-act-icr">${mainIcr || '-'} ICR</span>
                    </div>
                    <div class="main-act-label">${m.label}</div>
                    ${m.coding_instruction ? `<div class="main-act-warning">Consigne : ${m.coding_instruction}</div>` : ''}
                    ${m.date_end ? `<div class="main-act-warning" style="color:#ef4444;border-color:#ef444433;background:#1a0808;">Code expire : ${m.date_end}</div>` : ''}
                  </div>`;

            // Complementary gestures
            if (gs.length > 0) {
                h += `<div class="gestures-header"><span>Gestes complementaires</span><span>${gs.length}</span></div>`;
                for (const g of gs) {
                    const on = checked.has(g.code);
                    const icr = g.icr_public;
                    h += `<div class="gesture ${on?'on':''}" onclick="toggle('${g.code}')">
                            <div class="gesture-check"></div>
                            <div class="gesture-body">
                                <div class="gesture-top">
                                    <span class="gesture-code">${g.code}</span>
                                    <span class="gesture-icr ${icr?'':'zero'}">${icr ? '+'+icr : 'suppl.'}</span>
                                </div>
                                <div class="gesture-label">${g.label || '-'}</div>
                            </div>
                          </div>`;
                }
            }

            // Anesthesia
            if (an.length > 0) {
                h += `<div class="gestures-header" style="margin-top:10px"><span>Anesthesie</span><span>${an.length}</span></div>`;
                for (const a of an) {
                    const on = checked.has(a.code);
                    const icr = a.icr_public;
                    h += `<div class="gesture ${on?'on':''}" onclick="toggle('${a.code}')">
                            <div class="gesture-check"></div>
                            <div class="gesture-body">
                                <div class="gesture-top">
                                    <span class="gesture-code">${a.code}</span>
                                    <span class="gesture-icr ${icr?'':'zero'}">${icr ? '+'+icr : 'suppl.'}</span>
                                </div>
                                <div class="gesture-label">${a.label || '-'}</div>
                            </div>
                          </div>`;
                }
            }

            if (gs.length === 0 && an.length === 0) {
                h += '<div class="no-gestures">Pas de geste complementaire pour cet acte.</div>';
            }

            // Actions
            h += `<div class="actions">
                    <button class="btn btn-copy" onclick="copy_()">Copier</button>
                    <button class="btn btn-close" onclick="close()">Fermer</button>
                  </div>`;

            h += `<div class="source">Donnees officielles ATIH CCAM 2025. Associations verifiees.</div>`;
            h += '</div>';

            bp.innerHTML = h;
        }

        function toggle(code) {
            if (checked.has(code)) checked.delete(code); else checked.add(code);
            render();
        }

        // Override window.close
        window.close = undefined;
        function close() {
            active = null; plan = null; checked = null;
            bp.classList.remove('visible'); bp.innerHTML = '';
            search();
        }

        async function copy_() {
            const m = plan.main_code;
            const all = [...plan.complementary_gestures, ...plan.anesthesia_codes];
            const sel = all.filter(g => checked.has(g.code));
            const mainIcr = m.icr_public || 0;
            const selIcr = sel.reduce((s, g) => s + (g.icr_public || 0), 0);

            let t = `PLAN DE FACTURATION\n\n`;
            t += `Acte principal : ${m.code} - ${m.label}\nICR : ${mainIcr}\n\n`;
            if (sel.length) {
                t += `Gestes complementaires :\n`;
                sel.forEach(g => { t += `  ${g.code} - ${g.label || '-'} (ICR ${g.icr_public || 0})\n`; });
                t += `\n`;
            }
            t += `TOTAL ICR : ${mainIcr + selIcr}\n\nSource : ATIH CCAM 2025`;

            try { await navigator.clipboard.writeText(t); } catch(e) {
                const ta = document.createElement('textarea'); ta.value = t;
                document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
            }
            const btn = document.querySelector('.btn-copy');
            btn.textContent = 'Copie !'; btn.classList.add('ok');
            setTimeout(() => { btn.textContent = 'Copier'; btn.classList.remove('ok'); }, 1500);
        }
    </script>
</body>
</html>
